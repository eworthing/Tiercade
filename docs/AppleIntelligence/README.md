# Apple Intelligence Experimental Feature

**Status**: Experimental / Proof of Concept (Prototype-Only)
**Platforms**: iOS 26+, iPadOS 26+, macOS 26+ (native), visionOS 26+
**Framework**: FoundationModels

## Overview

Experimental integration of on-device Apple Intelligence for generating unique tier list items using schema-guided generation.

### Prototype Testing Notice
- This directory and related code paths exist to evaluate techniques on the small on-device model. They are not production architecture.
- Prompts must remain cross-domain. We do not specialize for particular list types because user queries may target any category.
- The final product will be re-architected around the best-performing method identified by these experiments. Treat this as disposable scaffolding.

## Documentation

- **[Unique List Generation Spec](UNIQUE_LIST_GENERATION_SPEC.md)** - Complete specification and algorithm
- **[Feature Flag Usage](FEATURE_FLAG_USAGE.md)** - How to enable/disable advanced generation
- **[Prototype Notice](PROTOTYPE_NOTICE.md)** - Scope, goals, and non-production disclaimer
- **[Deep Research (Oct 2025)](DEEP_RESEARCH_2025-10.md)** - Consolidated research plan, constraints, and experiment matrix
- **[RFC: Hybrid Backfill Implementation (archived)](archive/HYBRID_BACKFILL_IMPLEMENTATION.md)** - Implementation plan preserved for reference
- **[Test Results (2025-10-24)](archive/test-results-2025-10-24-negation-backfill-failure.md)** - Acceptance test snapshot
- **[Diagnostic Findings (T4 Guided Backfill, 2025-10-25)](archive/T4_GUIDED_BACKFILL_DIAGNOSTIC_FINDINGS.md)** - Point-in-time diagnostic analysis

## Known Issues & Limitations

### Retired Experiments

- **[Candidate-batch backfill](archive/candidate_batch_analysis.md)** (88.7% duplication) -
  Abandoned approach that generated items without avoid-lists. Model repeatedly
  produced the same high-probability items despite client-side deduplication.

### Framework Limitations

Based on testing against Apple's FoundationModels framework and verification against WWDC 2025 Session 301:

- **Guided generation enforces structure, not semantics** - `@Generable` validates JSON schema but ignores avoid-list constraints
- **Semantic duplicates not detected** - "USA" vs "United States" are treated as different
- **High duplicate rates in backfill** - 60-75% duplication when requesting items similar to existing ones
- **ChatGPT proposals lacked documentation** - Regex bucketing and initial-letter constraints are not supported APIs

### Current Behavior

- Circuit breaker triggers at 44-46 items for N=50 targets (prevents infinite loops)
- Acceptance test pass rate: 6/7 tests (85.7%)
- T3_Backfill fails due to guided generation's inability to respect avoid-lists

## Feature Flag

Controlled via `UniqueListGenerationFlags.enableAdvancedGeneration`:

- **DEBUG builds**: Enabled by default
- **Release builds**: Disabled by default
- **Override**: Use `--enable-advanced-generation` or `--disable-advanced-generation`
  build flags

See [FEATURE_FLAG_USAGE.md](FEATURE_FLAG_USAGE.md) for details.

## Testing

### Manual Acceptance Tests

Run acceptance tests via UI:

1. Build native macOS: `./build_install_launch.sh macos`
2. Open AI Chat (sparkles button)
3. Click green checkmark for acceptance tests
4. Results in `/tmp/tiercade_acceptance_test_report.json`

**Expected**: 6/7 tests pass (T3_Backfill known to fail)

### AI Testing Framework

Comprehensive automated testing for Apple Intelligence features:

**Run all test suites:**
```bash
./run_all_ai_tests.sh
```

**Analyze results:**
```bash
python3 analyze_test_results.py results/run-<TIMESTAMP>/
```

**Test suite structure:**
- **T1**: Basic unique list generation
- **T2**: Deduplication and backfill
- **T3**: Session recreation and retry logic
- **T4**: Guided backfill diagnostics
- **T5**: Coordinator experiments (A/B testing)

**Configuration files:**
- Suite definitions: `Tiercade/TestConfigs/TestSuites.json`
- Framework documentation: `Tiercade/TestConfigs/TESTING_FRAMEWORK.md`
- Feature flag usage: `docs/AppleIntelligence/FEATURE_FLAG_USAGE.md`

**Expected outputs:**
- Test results JSON: `results/run-<TIMESTAMP>/test-results.json`
- Raw logs: `results/run-<TIMESTAMP>/logs/`
- Analysis summary: Generated by `analyze_test_results.py`

**Pass/fail criteria:**
- Current baseline: 6/7 tests pass
- T3_Backfill expected to fail (guided generation limitation)
- Acceptable: ≥85% pass rate across all suites

## Architecture

**Algorithm**: Generate → Dedup → Backfill

1. **Pass 1**: Over-generate (M = ceil(1.6 × N)) with diverse sampling
2. **Client Dedup**: Normalize and filter by `normKey` (first appearance wins)
3. **Pass 2+**: Hybrid backfill (guided then unguided) with avoid-list, max 3 passes
4. **Optional**: Greedy fallback if delta ≤ 2

See [UNIQUE_LIST_GENERATION_SPEC.md](UNIQUE_LIST_GENERATION_SPEC.md) for full details.

## Future Work

- Semantic deduplication layer using embeddings
- Adaptive over-generation factor by domain
- Tool calling for validation loops (experimental)
- Multi-model ensemble for diversity
